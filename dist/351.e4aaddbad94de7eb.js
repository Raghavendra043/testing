"use strict";(self.webpackChunkopentele_client_html_angular=self.webpackChunkopentele_client_html_angular||[]).push([[351],{4546:(B,k,n)=>{n.d(k,{O:()=>C});var e=n(60),m=n(4466),T=n(5e3);let C=(()=>{class f{}return f.\u0275fac=function(x){return new(x||f)},f.\u0275mod=T.oAB({type:f}),f.\u0275inj=T.cJS({imports:[e.ez,m.m]}),f})()},8507:(B,k,n)=>{n.d(k,{G:()=>E});var e=n(5e3),m=n(619),T=n(1786),C=n(7362),f=n(4338),_=n(8351),x=n(4879),s=n(60);const U=function(r){return{clickable:r}};function y(r,c){if(1&r){const t=e.EpF();e.TgZ(0,"div",2)(1,"img",3),e.NdJ("click",function(){e.CHM(t);const a=e.oxw();return e.KtG(a.clickLogo())}),e.ALo(2,"translate"),e.qZA()()}if(2&r){const t=e.oxw();e.xp6(1),e.s9C("alt",e.lcZ(2,2,"LOGO_ARIA")),e.Q6J("ngClass",e.VKq(4,U,t.canClickLogo()))}}function L(r,c){if(1&r){const t=e.EpF();e.TgZ(0,"button",13),e.NdJ("click",function(){e.CHM(t);const a=e.oxw(2);return e.KtG(a.goBack())}),e._UZ(1,"i",14),e.qZA()}}function b(r,c){if(1&r){const t=e.EpF();e.TgZ(0,"button",15),e.NdJ("click",function(){e.CHM(t);const a=e.oxw(2);return e.KtG(a.goChangePassword())}),e._UZ(1,"i",16),e.qZA()}}function d(r,c){if(1&r){const t=e.EpF();e.TgZ(0,"button",17),e.NdJ("click",function(){e.CHM(t);const a=e.oxw(2);return e.KtG(a.goHome())}),e._UZ(1,"i",18),e.qZA()}}function g(r,c){if(1&r){const t=e.EpF();e.TgZ(0,"button",19),e.NdJ("click",function(){e.CHM(t);const a=e.oxw(2);return e.KtG(a.goLogout())}),e._UZ(1,"i",20),e.qZA()}}function h(r,c){if(1&r&&(e.TgZ(0,"nav",4)(1,"div",5),e.YNc(2,L,2,0,"button",6),e.YNc(3,b,2,0,"button",7),e.qZA(),e.TgZ(4,"div",8),e._UZ(5,"h1",9),e.qZA(),e.TgZ(6,"div",10),e.YNc(7,d,2,0,"button",11),e.YNc(8,g,2,0,"button",12),e.qZA()()),2&r){const t=e.oxw();e.xp6(2),e.Q6J("ngIf",t.showBackBtn),e.xp6(1),e.Q6J("ngIf",t.showChangePasswordBtn),e.xp6(2),e.Q6J("innerHtml",t.title,e.oJD),e.xp6(2),e.Q6J("ngIf",t.showHomeBtn),e.xp6(1),e.Q6J("ngIf",t.showLogoutBtn)}}let E=(()=>{class r{constructor(t,o,a,v,S,A,F){this.applicationRef=t,this.router=o,this.translate=a,this.native=v,this.appContext=S,this.config=A,this.authentication=F,this.showBackBtn=!1,this.showHomeBtn=!1,this.onHomeFun=()=>this.router.navigate(["/menu"]),this.isClinician=!1,this.title="",this.showChangePasswordBtn=!1,this.showLogoutBtn=!1,this.showLogo=!1,this.goBack=()=>{this.onBackFun?this.onBackFun():globalThis.history.back()},this.goLogout=()=>{const P=this.translate.instant("LOGOUT_CONFIRM_MSG"),I=this.translate.instant("OK"),D=this.translate.instant("CANCEL");this.native.showConfirmDialog(P,I,D,w=>{w&&(this.router.navigate(["/logout"]),setTimeout(()=>this.applicationRef.tick(),100))})},this.goChangePassword=()=>{this.router.navigate(["/change_password"])}}ngOnChanges(){this.title=this.title?this.translate.instant(this.title):""}canClickLogo(){return!!this.helpAndInfoUrl()}helpAndInfoUrl(){return this.config.getAppConfig().helpAndInfoUrl}clickLogo(){const t=this.helpAndInfoUrl();this.canClickLogo()&&void 0!==t&&this.native.openUrl(t)}goHome(){this.onHomeFun?this.onHomeFun():this.router.navigate(["/menu"])}goClinicianMenu(){this.appContext.requestParams.getAndClear("selectedPatient"),this.router.navigate(["/clinician_menu"])}}return r.\u0275fac=function(t){return new(t||r)(e.Y36(e.z2F),e.Y36(m.F0),e.Y36(T.sK),e.Y36(C.R),e.Y36(f.P),e.Y36(_.E),e.Y36(x.$))},r.\u0275cmp=e.Xpm({type:r,selectors:[["header-menu"]],inputs:{showBackBtn:"showBackBtn",onBackFun:"onBackFun",showHomeBtn:"showHomeBtn",onHomeFun:"onHomeFun",isClinician:"isClinician",title:"title",showChangePasswordBtn:"showChangePasswordBtn",showLogoutBtn:"showLogoutBtn",showLogo:"showLogo"},features:[e.TTD],decls:2,vars:2,consts:[["id","logo",4,"ngIf"],["id","header",4,"ngIf"],["id","logo"],["src","./assets/product-flavor/images/header.svg",3,"alt","ngClass","click"],["id","header"],[1,"header-left"],["id","back-button","type","button","class","button",3,"click",4,"ngIf"],["id","change-password-button","type","button","class","button",3,"click",4,"ngIf"],[1,"header-center"],["id","header-title",3,"innerHtml"],[1,"header-right"],["id","menu-button","type","button","class","button",3,"click",4,"ngIf"],["id","logout-button","type","button","class","button",3,"click",4,"ngIf"],["id","back-button","type","button",1,"button",3,"click"],["aria-hidden","true",1,"fal","fa-arrow-left"],["id","change-password-button","type","button",1,"button",3,"click"],["aria-hidden","true",1,"fal","fa-user-lock"],["id","menu-button","type","button",1,"button",3,"click"],["aria-hidden","true",1,"fal","fa-home"],["id","logout-button","type","button",1,"button",3,"click"],["aria-hidden","true",1,"fal","fa-sign-out"]],template:function(t,o){1&t&&(e.YNc(0,y,3,6,"div",0),e.YNc(1,h,9,5,"nav",1)),2&t&&(e.Q6J("ngIf",o.showLogo),e.xp6(1),e.Q6J("ngIf",!o.showLogo))},dependencies:[s.mk,s.O5,T.X$]}),r})()},351:(B,k,n)=>{n.r(k),n.d(k,{MenuModule:()=>Z});var e=n(60),m=n(619),T=n(5861),C=n(4185),f=n(520),_=n(8505),x=n(4004),s=n(5e3),U=n(4338),y=n(8351),L=n(4679),b=n(1786),d=n(5349),g=n(7362),h=n(8288),E=n(1866),r=n(7166),c=n(8858),t=n(211),o=n(4879),a=n(8507);function v(u,O){if(1&u&&(s.TgZ(0,"h1",5),s._uU(1),s.ALo(2,"translate"),s.qZA()),2&u){const i=s.oxw();s.xp6(1),s.lnq(" ",s.lcZ(2,3,"WELCOME"),", ",i.user.firstName," ",i.user.lastName," ")}}const S=function(u,O){return{important_list_item:u,normal_list_item:O}};function A(u,O){if(1&u&&(s.TgZ(0,"a",6)(1,"span",7),s._uU(2),s.qZA(),s._UZ(3,"i",8),s.qZA()),2&u){const i=O.$implicit;s.s9C("routerLink",i.url),s.Q6J("ngClass",s.WLB(6,S,i.important,!i.important)),s.xp6(2),s.Oqu(i.name),s.xp6(1),s.Gre("icon ",i.icon,"")}}const P=[{path:"",component:(()=>{class u{constructor(i,l,M,p,R,N,H,J,Y,G,K,W,j){this.appContext=i,this.config=l,this.util=M,this.router=p,this.translateService=R,this.messageThreads=N,this.native=H,this.questionnaireSchedules=J,this.videoService=Y,this.idle=G,this.notifications=K,this.clinicianService=W,this.authentication=j,this.model={canChangePassword:!1,menuItems:[]},this.isClinician=!1,this.user=this.appContext.getUser(),this.isClinician=this.clinicianService.isClinician(),this.appContext.requestParams.clearParam("useDefaultAuth")}ngOnInit(){const i=this.model.menuItems;this.user.links.questionnaires&&i.push({important:!1,icon:"fal fa-stethoscope",url:"../questionnaires",name:this.translateService.instant("MENU_PERFORM_MEASUREMENTS")}),this.user.links.threads&&i.push({important:!1,icon:"fal fa-comments",url:"../messages",name:this.translateService.instant("MENU_MESSAGES")}),this.user.links.acknowledgements&&i.push({important:!1,icon:"fal fa-check-circle",url:"../acknowledgements",name:this.translateService.instant("MENU_ACKNOWLEDGEMENTS")}),this.user.links.measurements&&i.push({important:!1,icon:"fal fa-chart-line",url:"../my_measurements",name:this.translateService.instant("MENU_MY_MEASUREMENTS")}),1==this.config.getAppConfig().showReplies&&i.push({important:!1,icon:"fal fa-tasks",url:"../questionnaire_results",name:this.translateService.instant("MENU_QUESTIONNAIRE_RESULTS")}),this.user.links.linksCategories&&i.push({important:!1,icon:"fal fa-book-medical",url:"../links_categories",name:this.translateService.instant("MENU_LINKS_CATEGORIES")}),this.user.links.calendar&&i.push({important:!1,icon:"fal fa-calendar-alt",url:"../calendar",name:this.translateService.instant("MENU_CALENDAR")}),this.model.canChangePassword=this.user.canChangePassword&&void 0!==this.user.links.changePassword&&!this.isClinician,this.model.canChangePassword&&this.appContext.requestParams.set("userInfo",{username:this.user.username,changePasswordUrl:this.user.links.changePassword}),this.isClinician||this.startIdleWatcher(),this.setupUnreadCounters(i),this.native.clientIsVideoEnabled(M=>{!0===M.enabled&&(this.checkAndJoin(),this.native.subscribeToMultipleMessages("appResumedEvent",()=>this.checkAndJoin()))})||console.debug("Couldn't deliver videoEnabledRequest -> Video not enabled"),this.isClinician||this.notifications.ensureDeviceRegisteredForPushNotifications(this.user)}checkAndJoin(){var i=this;return(0,T.Z)(function*(){var l;const M=null===(l=i.user)||void 0===l?void 0:l.links.individualSessions;if(null!=M)try{yield i.videoService.checkForSessionAndJoin(M)}catch(p){if(p instanceof f.UA&&401==p.status)throw localStorage.removeItem("authToken"),i.sendToLoginPage(),void i.appContext.requestParams.set("authenticationError","LOGGED_OUT");return void console.error(`Error checking for session: ${JSON.stringify(p)}`)}})()}sendToLoginPage(){const i=sessionStorage.getItem("loginUrl");null!==i?this.router.navigateByUrl(i):("/login"===this.router.url&&this.router.navigateByUrl("/",{skipLocationChange:!0}),this.router.navigate(["login"],{}))}startIdleWatcher(){this.idle.isRunning()||this.idle.watch()}updateUnreadMessages(i){this.messageThreads.list(this.user,!0).then(p=>{const R=p.results.map(N=>N.unreadFromOrganization).reduce((N,H)=>N+H,0);R>0&&(i.important=!0),i.name=this.translateService.instant("MENU_MESSAGES")+` (${R})`}).catch(p=>{console.warn(`Failed to fetch message threads with error: ${p}`)})}updateQuestionnaireSchedules(i){this.questionnaireSchedules.list(this.user,!0).pipe((0,x.U)(this.unansweredQuestionnaires),(0,_.b)(l=>{l.length>0&&(i.important=!0),i.name=`${this.translateService.instant("MENU_PERFORM_MEASUREMENTS")} (${l.length})`})).subscribe({next:l=>{this.native.updateScheduledQuestionnaires(l)||console.debug("Couldn't deliver update schedules request due to missing native layer")},error:l=>{console.warn(`Failed to fetch questionnaires schedules with error: ${l}`)}})}unansweredQuestionnaires(i){const l=new Date,M=(0,C.Z)(l,1);return i.filter(p=>p.scheduleWindowStart&&p.scheduleWindowStart<=l&&p.nextDeadline&&p.nextDeadline<=M)}setupUnreadCounters(i){const l=i.find(R=>"../messages"===R.url),M=i.find(R=>"../questionnaires"===R.url),p=()=>{this.util.exists(l)&&(console.debug("Updating unread messages..."),this.updateUnreadMessages(l)),this.util.exists(M)&&(console.debug("Updating unanswered questionnaires..."),this.updateQuestionnaireSchedules(M))};p(),this.native.subscribeToMultipleMessages("appResumedEvent",p)}goBack(){this.isClinician?(console.debug("Going back as a clinician and clearing patient authentication"),this.appContext.requestParams.getAndClear("selectedPatient"),this.authentication.deletePatientAuthHeader(),this.router.navigate(["clinician_menu"],{replaceUrl:!0})):globalThis.history.back()}}return u.\u0275fac=function(i){return new(i||u)(s.Y36(U.P),s.Y36(y.E),s.Y36(L.c),s.Y36(m.F0),s.Y36(b.sK),s.Y36(d.g),s.Y36(g.R),s.Y36(h.t),s.Y36(E.k),s.Y36(r.hX),s.Y36(c.T),s.Y36(t.N),s.Y36(o.$))},u.\u0275cmp=s.Xpm({type:u,selectors:[["app-menu"]],decls:5,vars:8,consts:[[1,"container"],[3,"title","showBackBtn","isClinician","onBackFun","showChangePasswordBtn","showLogoutBtn"],[1,"content"],["class","page-title",4,"ngIf"],["class","list_item",3,"routerLink","ngClass",4,"ngFor","ngForOf"],[1,"page-title"],[1,"list_item",3,"routerLink","ngClass"],[1,"before-icon"],["aria-hidden","true"]],template:function(i,l){1&i&&(s.TgZ(0,"div",0),s._UZ(1,"header-menu",1),s.TgZ(2,"nav",2),s.YNc(3,v,3,5,"h1",3),s.YNc(4,A,4,9,"a",4),s.qZA()()),2&i&&(s.xp6(1),s.Q6J("title","MENU")("showBackBtn",l.isClinician)("isClinician",l.isClinician)("onBackFun",l.goBack)("showChangePasswordBtn",l.model.canChangePassword)("showLogoutBtn",!l.isClinician),s.xp6(2),s.Q6J("ngIf",l.isClinician),s.xp6(1),s.Q6J("ngForOf",l.model.menuItems))},dependencies:[e.mk,e.sg,e.O5,m.yS,a.G,b.X$]}),u})()}];let I=(()=>{class u{}return u.\u0275fac=function(i){return new(i||u)},u.\u0275mod=s.oAB({type:u}),u.\u0275inj=s.cJS({imports:[m.Bz.forChild(P),m.Bz]}),u})();var D=n(4466),w=n(4546);let Z=(()=>{class u{}return u.\u0275fac=function(i){return new(i||u)},u.\u0275mod=s.oAB({type:u}),u.\u0275inj=s.cJS({imports:[e.ez,I,D.m,w.O]}),u})()},8858:(B,k,n)=>{n.d(k,{T:()=>s});var e=n(5861),m=n(520),T=n(2826),C=n(9808),f=n(5e3),_=n(7362),x=n(4679);let s=(()=>{class U{constructor(L,b,d){var g=this;this.native=L,this.util=b,this.http=d,this.clearPushNotificationRegistrationState=()=>{this.registrationPromise=void 0},this.registerDeviceForPushNotifications=h=>new Promise((r,c)=>{this.native.getDeviceToken(({deviceToken:o,deviceOS:a})=>this.registerDevice(h,o,a).then(()=>{console.debug(`Device with token: '${o}' successfully registered for push notifications`),r()}).catch(()=>{console.error(`Failed to register device token: ${o} for push notifications`)}))||console.debug("Couldn't request device token")}),this.ensureDeviceRegisteredForPushNotifications=h=>this.registrationPromise?this.registrationPromise.then(()=>!0,()=>!1):this.registerDeviceForPushNotifications(h),this.registerDevice=function(){var h=(0,e.Z)(function*(E,r,c){var t,o;if(!g.util.exists(null===(t=E.links)||void 0===t?void 0:t.notifications)||!g.util.exists(null===(o=E.links)||void 0===o?void 0:o.self))throw new TypeError("User object is missing a link to either 'patient' or 'notifications'");const a=(new m.qT).set(T.Hq,!0).set(T.SF,!0),v=E.links.self,S=E.links.notifications,A=S+"?patientUrl="+v,P=(yield(0,C.n)(g.http.get(A,{context:a}))).results.find(({patientUrl:I})=>I===v);return g.util.exists(P)&&g.util.exists(P.links)&&g.util.exists(P.links.device)?(0,C.n)(g.http.put(P.links.device,{patientUrl:P.patientUrl,deviceToken:r,deviceOS:c},{context:a})):(0,C.n)(g.http.post(S,{patientUrl:v,deviceToken:r,deviceOS:c}))});return function(E,r,c){return h.apply(this,arguments)}}()}}return U.\u0275fac=function(L){return new(L||U)(f.LFG(_.R),f.LFG(x.c),f.LFG(m.eN))},U.\u0275prov=f.Yz7({token:U,factory:U.\u0275fac,providedIn:"root"}),U})()},1866:(B,k,n)=>{n.d(k,{k:()=>b});var e=n(5e3),m=n(5861),T=n(60),C=n(520),f=n(9808),_=n(2826),x=n(4338),s=n(619);let U=(()=>{class d{constructor(h,E,r,c){var t=this;this.http=h,this.appContext=E,this.router=r,this.ngZone=c,this.constants=Object.freeze({roomCredentials:"roomCredentials",sessionUrl:"individualSessionUrl",joinConferencePath:"joinConference",loginPath:"login",authenticationError:"authenticationError"}),this.joinSession=function(){var o=(0,m.Z)(function*(a){const v=(new C.qT).set(_.SF,!0).set(_.Hq,!0);console.debug("Joining conference"),console.debug("Individual session:",JSON.stringify(a));const S=a.links.individualSession,A=T.Ye.joinWithSlash(S,"participant");try{const F={present:!0},P=yield(0,f.n)(t.http.put(A,F,{context:v}));console.debug("Room status:",JSON.stringify(P)),t.appContext.requestParams.set(t.constants.roomCredentials,P.roomCredentials),t.appContext.requestParams.set(t.constants.sessionUrl,S),t.ngZone.run(()=>{console.debug("Redirecting to join conference component"),t.router.navigate([t.constants.joinConferencePath])})}catch(F){const P=F instanceof C.UA?`Status: ${F.status}`:JSON.stringify(F);console.error("Could not join session %s. %s",a,P)}});return function(a){return o.apply(this,arguments)}}(),this.leaveSession=function(){var o=(0,m.Z)(function*(a){console.debug("Leaving individual session");const v=(new C.qT).set(_.SF,!0).set(_.Hq,!0);console.debug(`Individual sessions URL: ${a}`);const S=T.Ye.joinWithSlash(a,"participant"),A={present:!1};try{yield(0,f.n)(t.http.put(S,A,{context:v})),console.debug("Succesfully left individual session")}catch(F){console.debug("Failed to leave individual session"),console.debug(`Status: ${F}`)}});return function(a){return o.apply(this,arguments)}}(),this.checkForSession=function(){var o=(0,m.Z)(function*(a){const v=new URL(a);v.searchParams.set("status","open");const S=(new C.qT).set(_.SF,!0).set(_.Hq,!0);try{return(0,f.n)(t.http.get(v.toString(),{context:S}))}catch(A){return console.error(`Error occurred trying to check for pending individual sessions: ${A}`),Promise.resolve(void 0)}});return function(a){return o.apply(this,arguments)}}(),this.checkForSessionAndJoin=function(){var o=(0,m.Z)(function*(a){const v=yield t.checkForSession(a);void 0!==v&&v.results.length>0&&t.joinSession(v.results[0])});return function(a){return o.apply(this,arguments)}}(),this.isHostPresent=o=>{const a=(new C.qT).set(_.SF,!0).set(_.Hq,!0);return(0,f.n)(this.http.get(o,{context:a}))}}}return d.\u0275fac=function(h){return new(h||d)(e.LFG(C.eN),e.LFG(x.P),e.LFG(s.F0),e.LFG(e.R0b))},d.\u0275prov=e.Yz7({token:d,factory:d.\u0275fac,providedIn:"root"}),d})();var y=n(7362);let L=(()=>{class d{constructor(h,E,r){this.native=h,this.individualSessionsApi=E,this.router=r,this.texts=Object.freeze({conferenceStarted:"CONFERENCE_STARTED",conferenceEnded:"CONFERENCE_ENDED",conferenceError:"CONFERENCE_ERROR"}),this.constants=Object.freeze({status:"status",info:"info",error:"error",timeoutInMillis:3e3,menuPath:"/menu",videoConferenceResponse:"videoConferenceResponse",incomingVideoCall:"incomingVideoCall"}),this.states=Object.freeze({prompted:"prompted",joining:"joining",joined:"joined",disconnected:"disconnected"}),this.listenForNativeEvent=(c,t)=>{this.native.subscribeToMultipleMessages(this.constants.videoConferenceResponse,a=>{this.handleEvent(c,t,a.event)})},this.listenForIncomingCall=c=>{this.native.unsubscribeAll(this.constants.incomingVideoCall),this.native.subscribeToMultipleMessages(this.constants.incomingVideoCall,()=>{console.debug("received 'incomingVideoCall' message"),this.individualSessionsApi.checkForSessionAndJoin(c)})},this.handleEvent=(c,t,o)=>{console.debug(`Event: ${JSON.stringify(o)}`);const a=o.type;a===this.constants.status?this.handleStatusEvent(c,t,o):console.warn(`Unknown event type: ${a}`)},this.handleStatusEvent=(c,t,o)=>{const a=o.status,v=a.type,S=a.message;switch(v){case this.constants.error:this.handleErrorEvent(c,t,S);break;case this.constants.info:this.handleInfoEvent(c,t,S);break;default:console.warn(`Unknown status type: ${v}`)}},this.handleErrorEvent=(c,t,o)=>{t.state=this.states.disconnected,o===this.texts.conferenceError?this.endSession(c):t.error=o},this.handleInfoEvent=(c,t,o)=>{switch(t.message=o,o){case this.texts.conferenceStarted:console.debug("Conference started"),t.state=this.states.joined;break;case this.texts.conferenceEnded:t.state=this.states.disconnected,this.endSession(c);break;default:console.debug(`Info message received: ${JSON.stringify(o)}`),t.info=o}},this.endSession=c=>{console.debug("CONFERENCE ENDED"),this.individualSessionsApi.leaveSession(c),this.native.leaveConference()||console.debug("Couldn't leave conference"),this.native.unsubscribeAll(this.constants.videoConferenceResponse),this.router.navigate([this.constants.menuPath])}}}return d.\u0275fac=function(h){return new(h||d)(e.LFG(y.R),e.LFG(U),e.LFG(s.F0))},d.\u0275prov=e.Yz7({token:d,factory:d.\u0275fac,providedIn:"root"}),d})(),b=(()=>{class d{constructor(h,E){this.individualSessionsApi=h,this.videoListener=E,this.checkForSessionAndJoin=this.individualSessionsApi.checkForSessionAndJoin,this.leaveSession=this.individualSessionsApi.leaveSession,this.isHostPresent=this.individualSessionsApi.isHostPresent,this.sessionEnded=this.videoListener.endSession,this.listenForNativeEvent=this.videoListener.listenForNativeEvent,this.listenForIncomingCall=this.videoListener.listenForIncomingCall}}return d.\u0275fac=function(h){return new(h||d)(e.LFG(U),e.LFG(L))},d.\u0275prov=e.Yz7({token:d,factory:d.\u0275fac,providedIn:"root"}),d})()}}]);