"use strict";(self.webpackChunkopentele_client_html_angular=self.webpackChunkopentele_client_html_angular||[]).push([[65],{2065:(re,w,l)=>{l.r(w),l.d(w,{MessagesModule:()=>ie});var g=l(60),p=l(3075),_=l(619),e=l(5e3),C=l(4338),T=l(5349),Z=l(7362),M=l(8507),x=l(9797);const A=function(s,a){return{important_list_item:s,normal_list_item:a}};function I(s,a){if(1&s){const t=e.EpF();e.TgZ(0,"a",5),e.NdJ("click",function(){const r=e.CHM(t).index,i=e.oxw();return e.KtG(i.showMessageThread(r))}),e.TgZ(1,"span"),e._uU(2),e.qZA()()}if(2&s){const t=a.$implicit;e.Q6J("ngClass",e.WLB(3,A,t.unreadCount,!t.unreadCount)),e.xp6(2),e.AsE(" ",t.name," ",t.unreadCount>0?"("+t.unreadCount+")":""," ")}}let E=(()=>{class s{constructor(t,n,o,r){this.appContext=t,this.messageThreads=n,this.native=o,this.router=r,this.model={state:"Loading",departments:[]},this.showMessageThread=i=>{const c=this.model.departments,m=c.length>1;this.appContext.requestParams.set("selectedDepartment",c[i]),this.appContext.requestParams.set("hasOtherThreads",m),1===this.model.departments.length?this.router.navigate(["messages/"+i+"/thread"],{replaceUrl:!0}):this.router.navigate(["messages/"+i+"/thread"])},this.onSuccess=i=>{const c=i.results.map(d=>({name:d.organizationName,url:d.links.organization,unreadCount:d.unreadFromOrganization,messageThread:d})),h=this.user.organizations.map(d=>({name:d.name,url:d.url,messageThread:void 0,unreadCount:0})),m={};for(const d of[...h,...c])m[d.url]=d;this.model.departments=Object.values(m),this.model.state="Loaded",this.native.clearUnreadMessages()||console.debug("Couldn't clear unread messages due to missing native layer"),1===this.model.departments.length&&this.showMessageThread(0)},this.onError=i=>{this.model.state="Failed",console.error(`Failed to load messages due to error: ${i}`)},this.user=this.appContext.getUser(),this.messageThreads.list(this.user,!1).then(this.onSuccess).catch(this.onError)}}return s.\u0275fac=function(t){return new(t||s)(e.Y36(C.P),e.Y36(T.g),e.Y36(Z.R),e.Y36(_.F0))},s.\u0275cmp=e.Xpm({type:s,selectors:[["app-messages"]],decls:5,vars:8,consts:[[1,"container"],[3,"showBackBtn","title"],[3,"stateModel","hasNoData","noDataMessage","loadingMessage","failedMessage"],[1,"content"],["class","list_item",3,"ngClass","click",4,"ngFor","ngForOf"],[1,"list_item",3,"ngClass","click"]],template:function(t,n){1&t&&(e.TgZ(0,"div",0),e._UZ(1,"header-menu",1)(2,"loading-state",2),e.TgZ(3,"nav",3),e.YNc(4,I,3,6,"a",4),e.qZA()()),2&t&&(e.xp6(1),e.Q6J("showBackBtn",!0)("title","MESSAGES_TITLE"),e.xp6(1),e.Q6J("stateModel",n.model.state)("hasNoData",0===n.model.departments.length)("noDataMessage","MESSAGES_NO_THREADS")("loadingMessage","MESSAGES_LOADING")("failedMessage","MESSAGES_FAILED"),e.xp6(2),e.Q6J("ngForOf",n.model.departments))},dependencies:[g.mk,g.sg,M.G,x.X]}),s})();var D=l(8779),v=l(1786),F=l(4679),k=l(2914);function P(s,a){if(1&s){const t=e.EpF();e.TgZ(0,"img",3),e.NdJ("click",function(){e.CHM(t);const o=e.oxw();return e.KtG(o.zoom())}),e.qZA()}if(2&s){const t=e.oxw();e.s9C("src",t.src,e.LSH)}}function J(s,a){1&s&&e._UZ(0,"i",7)}function U(s,a){1&s&&e._UZ(0,"i",8)}function N(s,a){if(1&s&&(e.TgZ(0,"div",4),e.YNc(1,J,1,0,"i",5),e.YNc(2,U,1,0,"i",6),e.qZA()),2&s){const t=e.oxw();e.xp6(1),e.Q6J("ngIf",!t.previewLoaded),e.xp6(1),e.Q6J("ngIf",t.previewLoaded)}}function L(s,a){1&s&&e._UZ(0,"i",14)}function y(s,a){if(1&s&&e._UZ(0,"img",15),2&s){const t=e.oxw(2);e.s9C("src",t.fullSrc,e.LSH)}}function b(s,a){if(1&s){const t=e.EpF();e.TgZ(0,"button",16),e.NdJ("click",function(o){e.CHM(t);const r=e.oxw(2);return e.KtG(r.openDeletionDialog(o))}),e._UZ(1,"i",17),e._uU(2),e.ALo(3,"translate"),e.qZA()}2&s&&(e.xp6(2),e.hij(" ",e.lcZ(3,1,"DELETE")," "))}function O(s,a){if(1&s){const t=e.EpF();e.TgZ(0,"button",18),e.NdJ("click",function(o){e.CHM(t);const r=e.oxw(2);return e.KtG(r.confirmDelete(o))}),e._UZ(1,"i",17),e._uU(2),e.ALo(3,"translate"),e.qZA()}2&s&&(e.xp6(2),e.hij(" ",e.lcZ(3,1,"CONFIRM_DELETE")," "))}function Q(s,a){if(1&s){const t=e.EpF();e.TgZ(0,"div",9),e.NdJ("click",function(){e.CHM(t);const o=e.oxw();return e.KtG(o.closeModal())}),e.YNc(1,L,1,0,"i",10),e.YNc(2,y,1,1,"img",11),e.YNc(3,b,4,3,"button",12),e.YNc(4,O,4,3,"button",13),e.qZA()}if(2&s){const t=e.oxw();e.xp6(1),e.Q6J("ngIf",!t.loaded),e.xp6(1),e.Q6J("ngIf",t.loaded&&t.open),e.xp6(1),e.Q6J("ngIf",t.showDelete&&!t.deleteClicked),e.xp6(1),e.Q6J("ngIf",t.deleteClicked)}}let G=(()=>{class s{constructor(t){this.messageThreads=t,this.showDelete=!1,this.delete=new e.vpe,this.open=!1,this.deleteClicked=!1,this.previewLoaded=!1,this.loaded=!1}ngAfterViewInit(){this.messageThreads.getAttachmentDataUrl(this.thumbnailUrl).subscribe({next:t=>{this.src=t,this.previewLoaded=!0},error:t=>{this.previewLoaded=!0,console.error(t)}})}zoom(){this.open=!0,this.deleteClicked=!1,this.messageThreads.getAttachmentDataUrl(this.fullImageUrl).subscribe({next:t=>{this.loaded=!0,this.fullSrc=t},error:console.error})}closeModal(){this.open=!1,this.deleteClicked=!1}openDeletionDialog(t){t.stopPropagation(),this.deleteClicked=!0}confirmDelete(t){t.stopPropagation(),this.messageThreads.deleteAttachment(this.fullImageUrl).subscribe({next:()=>{this.open=!1,this.delete.emit()},error:console.error})}}return s.\u0275fac=function(t){return new(t||s)(e.Y36(T.g))},s.\u0275cmp=e.Xpm({type:s,selectors:[["thread-image"]],inputs:{fullImageUrl:"fullImageUrl",thumbnailUrl:"thumbnailUrl",showDelete:"showDelete"},outputs:{delete:"delete"},decls:3,vars:3,consts:[["alt","","class","thread-image click-to-zoom",3,"src","click",4,"ngIf"],["class","thread-image thread-image-placeholder",4,"ngIf"],["class","modal",3,"click",4,"ngIf"],["alt","",1,"thread-image","click-to-zoom",3,"src","click"],[1,"thread-image","thread-image-placeholder"],["class","fa fa-spinner fa-spin",4,"ngIf"],["class","fa fa-times",4,"ngIf"],[1,"fa","fa-spinner","fa-spin"],[1,"fa","fa-times"],[1,"modal",3,"click"],["class","fa fa-spin fa-spinner fa-2x",4,"ngIf"],["alt","",3,"src",4,"ngIf"],["class","delete",3,"click",4,"ngIf"],["class","confirm-delete",3,"click",4,"ngIf"],[1,"fa","fa-spin","fa-spinner","fa-2x"],["alt","",3,"src"],[1,"delete",3,"click"],[1,"fa","fa-trash"],[1,"confirm-delete",3,"click"]],template:function(t,n){1&t&&(e.YNc(0,P,1,1,"img",0),e.YNc(1,N,3,2,"div",1),e.YNc(2,Q,5,4,"div",2)),2&t&&(e.Q6J("ngIf",n.src),e.xp6(1),e.Q6J("ngIf",!n.src),e.xp6(1),e.Q6J("ngIf",n.open))},dependencies:[g.O5,v.X$]}),s})();function Y(s,a){if(1&s&&(e.TgZ(0,"div",5)(1,"div",6),e._uU(2),e.qZA()()),2&s){const t=e.oxw();e.xp6(2),e.hij("+",t.filePreviews.length-2,"")}}function B(s,a){if(1&s){const t=e.EpF();e.TgZ(0,"div",5),e._UZ(1,"img",7),e.TgZ(2,"a",8),e.NdJ("click",function(){const r=e.CHM(t).$implicit,i=e.oxw();return e.KtG(i.cancel(r))}),e._UZ(3,"i",9),e.qZA()()}if(2&s){const t=a.$implicit;e.xp6(1),e.Q6J("src",t.preview,e.LSH)}}let z=(()=>{class s{constructor(){this.filePreviews=[],this.filePreviewsChange=new e.vpe}uploadFile(t){const n=t.target.files[0];if(n){const o=new FileReader;o.readAsDataURL(n),o.onload=r=>{const i=new Image;i.onload=()=>{var c;let h=i.height,m=i.width;const f=1400;i.width>i.height&&i.width>f&&(m=f,h=i.height*f/i.width),i.height>i.width&&i.height>f&&(h=f,m=i.width*f/i.height);const d=document.createElement("canvas");d.width=m,d.height=h,null===(c=d.getContext("2d"))||void 0===c||c.drawImage(i,0,0,m,h);const S=d.toDataURL("image/jpeg");fetch(S).then(u=>u.blob()).then(u=>{console.log("blob"),console.log(u),console.log("file"),console.log(n);const oe={file:new File([u],n.name,{type:u.type}),preview:S};this.filePreviews.push(oe)})},i.src=r.target.result},this.filePreviewsChange.emit(this.filePreviews)}}cancel(t){this.filePreviews=this.filePreviews.filter(n=>n.file.name!=t.file.name)}}return s.\u0275fac=function(t){return new(t||s)},s.\u0275cmp=e.Xpm({type:s,selectors:[["image-picker"]],inputs:{filePreviews:"filePreviews"},outputs:{filePreviewsChange:"filePreviewsChange"},decls:6,vars:5,consts:[["class","image-preview",4,"ngIf"],["class","image-preview",4,"ngFor","ngForOf"],["for","file-upload",1,"file-upload-label"],[1,"far","fa-image","icon"],["id","file-upload","type","file","accept","image/*",2,"display","none",3,"change"],[1,"image-preview"],[1,"preview","ellipsis"],[1,"preview",3,"src"],[1,"close-button",3,"click"],[1,"fa","fa-times","fa-lg"]],template:function(t,n){1&t&&(e.YNc(0,Y,3,1,"div",0),e.YNc(1,B,4,1,"div",1),e.ALo(2,"slice"),e.TgZ(3,"label",2),e._UZ(4,"i",3),e.qZA(),e.TgZ(5,"input",4),e.NdJ("change",function(r){return n.uploadFile(r)}),e.qZA()),2&t&&(e.Q6J("ngIf",n.filePreviews.length>2),e.xp6(1),e.Q6J("ngForOf",e.xi3(2,2,n.filePreviews,-2)))},dependencies:[g.sg,g.O5,g.OU]}),s})();var R=l(8348);let H=(()=>{class s{constructor(){this.urls=/(https?:\/\/(?:www.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9].[^ ]{2,}|www.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9].[^ ]{2,}|https?:\/\/(?:www.|(?!www))[a-zA-Z0-9]+.[^ ]{2,}|www.[a-zA-Z0-9]+.[^ ]{2,})/g}transform(t){return t&&this.parseUrl(t)}parseUrl(t){return t.match(this.urls)&&(t=t.replace(this.urls,function(o,r){const i=o,c=i.replace(r+"://","");return'<a href="'+i+'" target="_blank">'+c+"</a>"})),t}}return s.\u0275fac=function(t){return new(t||s)},s.\u0275pipe=e.Yjl({name:"clickableLinks",type:s,pure:!0}),s})();function j(s,a){if(1&s){const t=e.EpF();e.TgZ(0,"thread-image",21),e.NdJ("delete",function(){e.CHM(t);const o=e.oxw(2);return e.KtG(o.refresh())}),e.qZA()}if(2&s){const t=a.$implicit,n=e.oxw().$implicit;e.Q6J("fullImageUrl",t.full)("thumbnailUrl",t.thumbnail)("showDelete","patient"===n.sender.type)}}const q=function(s,a,t){return{from_clinician:s,from_patient:a,unread:t}};function K(s,a){if(1&s&&(e.TgZ(0,"div",17)(1,"span",18),e._uU(2),e.ALo(3,"amDateFormat"),e.ALo(4,"amDateFormat"),e.qZA(),e.TgZ(5,"div"),e._UZ(6,"p",19),e.ALo(7,"clickableLinks"),e.qZA(),e.YNc(8,j,1,3,"thread-image",20),e.qZA()),2&s){const t=a.$implicit,n=e.oxw();e.MGl("id","message-",t.timestamp,""),e.Q6J("ngClass",e.kEZ(16,q,"organization"===t.sender.type,"patient"===t.sender.type,!1===t.isRead)),e.xp6(2),e.lnq(" ",t.sender.name,", ",e.xi3(3,8,t.timestamp,"D MMM"),", ",e.xi3(4,11,t.timestamp,"LT")," "),e.xp6(4),e.Q6J("innerHtml",e.lcZ(7,14,t.body),e.oJD),e.xp6(2),e.Q6J("ngForOf",null==t.links?null:t.links.attachments)("ngForTrackBy",n.attachmentByFull)}}function $(s,a){1&s&&e._UZ(0,"i",22)}function X(s,a){1&s&&e._UZ(0,"i",23)}const V=function(s){return{disabled:s}},W=[{path:"",component:E},{path:":id/thread",component:(()=>{class s{constructor(t,n,o,r,i){this.appContext=t,this.messageThreads=n,this.translate=o,this.router=r,this.utils=i,this.model={state:"Loading",isSending:!1,newMessage:"",hasOtherThreads:!1,title:"",messages:[],notifications:{info:void 0,error:void 0},filePreviews:[]},this.onSuccess=c=>{this.model.state="Loaded",this.model.notifications.info=void 0,c.sort((h,m)=>{const f=new Date(h.timestamp),d=new Date(m.timestamp);return(0,D.Z)(f,d)}),this.selectedDepartment.messageThread&&this.messageThreads.markAsRead(this.selectedDepartment.messageThread),this.model.messages=c},this.onError=c=>{this.model.notifications.info=void 0,this.model.state="Failed",console.error(`Failed to load messages due to error: ${c}`)}}ngOnInit(){var t;if(!this.appContext.requestParams.containsKey("selectedDepartment"))return void this.router.navigate(["menu"]);const n=this.appContext.requestParams.get("selectedDepartment");if(!this.utils.exists(n))throw new Error("No selected department");this.selectedDepartment=n;const o=null!==(t=this.appContext.requestParams.get("hasOtherThreads"))&&void 0!==t&&t;this.model=Object.assign(Object.assign({},this.model),{hasOtherThreads:o,title:o?this.selectedDepartment.name:this.translate.instant("MESSAGES_TITLE")}),this.selectedDepartment.messageThread?this.messageThreads.getMessages(this.selectedDepartment.messageThread).then(this.onSuccess):this.model.state="Loaded"}isValid(){return this.model.newMessage&&this.model.newMessage.length>0||this.model.filePreviews.length>0}submit(){this.model.isSending=!0,this.model.notifications.error=void 0,this.model.notifications.info=this.translate.instant("MESSAGES_SENDING");const t={text:this.model.newMessage,sendDate:new Date},r=this.appContext.getUser();if(!this.utils.exists(r))throw new Error("No user currently logged in");this.messageThreads.create(r,this.selectedDepartment.url,this.model.newMessage,this.model.filePreviews.map(i=>i.file)).subscribe({next:()=>{this.model.newMessage="",this.model.filePreviews=[];const i={body:t.text,timestamp:(new Date).toISOString(),sender:{type:"patient"}};this.model.messages.push(i),this.model.notifications.info=this.translate.instant("MESSAGES_SENT"),this.model.isSending=!1,setTimeout(()=>{this.model.notifications.info=void 0},2e3),this.selectedDepartment.messageThread&&this.messageThreads.getMessages(this.selectedDepartment.messageThread).then(this.onSuccess)},error:i=>{this.model.isSending=!1,this.model.notifications.info=void 0,this.model.notifications.error=this.translate.instant("MESSAGES_ERROR_COULD_NOT_SEND"),console.error(i),console.error("Failed to send message")}})}refresh(){this.model.messages=[],this.messageThreads.getMessages(this.selectedDepartment.messageThread).then(this.onSuccess)}messageByTimestamp(t,n){return n.timestamp}attachmentByFull(t,n){return n.full}}return s.\u0275fac=function(t){return new(t||s)(e.Y36(C.P),e.Y36(T.g),e.Y36(v.sK),e.Y36(_.F0),e.Y36(F.c))},s.\u0275cmp=e.Xpm({type:s,selectors:[["app-thread"]],viewQuery:function(t,n){if(1&t&&e.Gf(p.F,5),2&t){let o;e.iGM(o=e.CRH())&&(n.ngForm=o.first)}},decls:23,vars:30,consts:[[1,"container"],[3,"showBackBtn","showHomeBtn","title"],[3,"stateModel","hasNoData","noDataMessage","loadingMessage","failedMessage"],[3,"info","error"],[1,"content",2,"display","flex","flex-direction","column-reverse"],["id","messages"],["class","message",3,"ngClass","id",4,"ngFor","ngForOf","ngForTrackBy"],["id","char-count"],["id","write_message","name","newMessageForm",3,"ngSubmit"],["newMessageForm","ngForm"],["type","textarea","name","message","maxlength","1800",3,"placeholder","ngModel","ngModelChange"],["newMessage","ngModel"],[1,"image-picker-component",3,"filePreviews","filePreviewsChange"],["id","send-container",3,"ngClass"],["id","submit","type","submit",3,"disabled"],["class","fas fa-paper-plane icon",4,"ngIf"],["class","fa fa-spin fa-spinner fa",4,"ngIf"],[1,"message",3,"ngClass","id"],[1,"message_header"],[3,"innerHtml"],[3,"fullImageUrl","thumbnailUrl","showDelete","delete",4,"ngFor","ngForOf","ngForTrackBy"],[3,"fullImageUrl","thumbnailUrl","showDelete","delete"],[1,"fas","fa-paper-plane","icon"],[1,"fa","fa-spin","fa-spinner","fa"]],template:function(t,n){1&t&&(e.TgZ(0,"div",0),e._UZ(1,"header-menu",1)(2,"loading-state",2)(3,"notifications",3),e.TgZ(4,"div",4)(5,"div",5),e.YNc(6,K,9,20,"div",6),e.qZA()(),e.TgZ(7,"div",7)(8,"span"),e._uU(9),e.ALo(10,"translate"),e.qZA()(),e.TgZ(11,"form",8,9),e.NdJ("ngSubmit",function(){return n.submit()}),e.TgZ(13,"textarea",10,11),e.NdJ("ngModelChange",function(r){return n.model.newMessage=r}),e.ALo(15,"translate"),e.qZA(),e.TgZ(16,"image-picker",12),e.NdJ("filePreviewsChange",function(r){return n.model.filePreviews=r}),e.qZA(),e.TgZ(17,"div",13)(18,"button",14),e.YNc(19,$,1,0,"i",15),e.YNc(20,X,1,0,"i",16),e._uU(21),e.ALo(22,"translate"),e.qZA()()()()),2&t&&(e.xp6(1),e.Q6J("showBackBtn",!0)("showHomeBtn",n.model.hasOtherThreads)("title",n.model.title),e.xp6(1),e.Q6J("stateModel",n.model.state)("hasNoData",0===n.model.messages.length)("noDataMessage","MESSAGES_NO_MESSAGES")("loadingMessage","MESSAGES_LOADING")("failedMessage","MESSAGES_FAILED"),e.xp6(1),e.Q6J("info",n.model.notifications.info)("error",n.model.notifications.error),e.xp6(3),e.Q6J("ngForOf",n.model.messages)("ngForTrackBy",n.messageByTimestamp),e.xp6(3),e.AsE(" ",1800-n.model.newMessage.length," ",e.lcZ(10,22,"MESSAGES_CHARACTERS_LEFT")," "),e.xp6(4),e.s9C("placeholder",e.lcZ(15,24,"MESSAGES_FORM_MESSAGE")),e.Q6J("ngModel",n.model.newMessage),e.xp6(3),e.Q6J("filePreviews",n.model.filePreviews),e.xp6(1),e.Q6J("ngClass",e.VKq(28,V,!n.isValid())),e.xp6(1),e.Q6J("disabled",!n.isValid()),e.xp6(1),e.Q6J("ngIf",!n.model.isSending),e.xp6(1),e.Q6J("ngIf",n.model.isSending),e.xp6(1),e.hij(" ",e.lcZ(22,26,"MESSAGES_SEND")," "))},dependencies:[g.mk,g.sg,g.O5,M.G,p._Y,p.Fj,p.JJ,p.JL,p.nD,p.On,p.F,x.X,k.t,G,z,v.X$,R.Ek,H]}),s})()}];let ee=(()=>{class s{}return s.\u0275fac=function(t){return new(t||s)},s.\u0275mod=e.oAB({type:s}),s.\u0275inj=e.cJS({imports:[_.Bz.forChild(W),_.Bz]}),s})();var te=l(4546),se=l(4466),ne=l(9017),ae=l(1231);let ie=(()=>{class s{}return s.\u0275fac=function(t){return new(t||s)},s.\u0275mod=e.oAB({type:s}),s.\u0275inj=e.cJS({imports:[g.ez,ee,te.O,se.m,p.u5,ne.I,ae.F]}),s})()}}]);