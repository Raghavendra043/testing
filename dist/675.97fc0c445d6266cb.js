"use strict";(self.webpackChunkopentele_client_html_angular=self.webpackChunkopentele_client_html_angular||[]).push([[675],{5675:(ne,N,o)=>{o.r(N),o.d(N,{CreatePatientModule:()=>W});var h=o(60),E=o(619),I=o(5861),r=o(3075),e=o(5e3),x=o(4338),R=o(2279),q=o(1786),O=o(4679),F=o(4879),w=o(4865),G=o(5969),P=o(520),g=o(2826),v=o(1480),S=o(9808),M=o(8351);let J=(()=>{class n{constructor(a,t){this.http=a,this.configService=t,this.appConfig=this.configService.getAppConfig()}getThresholdForPatientGroup(a){const t=(0,v.E)(this.appConfig.baseUrl,"thresholds/patient-group-thresholds"),i=(0,v.E)(t,`?patientGroup=${a}`),s={context:(new P.qT).set(g.Hq,!0).set(g.SF,!0)};return(0,S.n)(this.http.get(i,s))}addThresholdToPatient(a){const t=(0,v.E)(this.appConfig.baseUrl,"thresholds/patient-thresholds"),i={context:(new P.qT).set(g.Hq,!0).set(g.SF,!0)};return(0,S.n)(this.http.post(t,a,i))}addPatientGroupThresholdsToPatient(a,t){var i=this;return(0,I.Z)(function*(){var s;const p=a.links.self;for(const f of t){const T=yield i.getThresholdForPatientGroup(f);if(T.results.length>0)for(const c of T.results){c.links&&delete c.links;const Z=Object.assign(Object.assign({},c),{links:{patient:p}});try{yield i.addThresholdToPatient(Z)}catch(u){if(console.log("insde catch"),console.log(u),null!==(s=null==u?void 0:u.error)&&void 0!==s&&s.errors){const _=u.error.errors.find(A=>"exists"===A.error);console.warn(_?`Patient already has threshold: '${c.measurementType}' so this threshold will be ignored ${JSON.stringify(c)}`:`Error occured when creating threshold for patient: ${JSON.stringify(u)}`)}}}else console.debug(`Patient group: '${f}' does not have any thresholds`)}})()}}return n.\u0275fac=function(a){return new(a||n)(e.LFG(P.eN),e.LFG(M.E))},n.\u0275prov=e.Yz7({token:n,factory:n.\u0275fac,providedIn:"root"}),n})();var b=o(8507),y=o(3056);function k(n,l){1&n&&(e.TgZ(0,"div",45),e._UZ(1,"i",46),e._uU(2),e.ALo(3,"translate"),e.qZA()),2&n&&(e.xp6(2),e.hij(" ",e.lcZ(3,1,"CLINICIAN_PERMISSION_WARNING")," "))}function B(n,l){1&n&&(e.TgZ(0,"div",47),e._UZ(1,"i",28),e._uU(2),e.ALo(3,"translate"),e.qZA()),2&n&&(e.xp6(2),e.hij(" ",e.lcZ(3,1,"CREATE_PATIENT_CREATED")," "))}function Q(n,l){if(1&n&&(e.TgZ(0,"li"),e._uU(1),e.qZA()),2&n){const a=l.$implicit;e.xp6(1),e.Oqu(a)}}function D(n,l){if(1&n&&(e.TgZ(0,"div",48)(1,"div",49)(2,"span",50),e._UZ(3,"i",46),e._uU(4),e.ALo(5,"translate"),e.qZA(),e.YNc(6,Q,2,1,"li",51),e.qZA()()),2&n){const a=e.oxw();e.xp6(4),e.Oqu(e.lcZ(5,2,"CREATE_PATIENT_FAILED")),e.xp6(2),e.Q6J("ngForOf",a.model.errors)}}function Y(n,l){1&n&&e._UZ(0,"i",52)}function V(n,l){1&n&&e._UZ(0,"i",53)}const d=function(n){return{warning:n}},z=function(n,l){return{placeholder:n,warning:l}},j=[{path:"",component:(()=>{class n{constructor(a,t,i,s,p,f,T,c,Z,u,_){this.formBuilder=a,this.appContext=t,this.patientService=i,this.router=s,this.translate=p,this.utils=f,this.authentication=T,this.userSession=c,this.idp2Service=Z,this.thresholdService=u,this.elementRef=_,this.hasPermissions=!1,this.sexList=[{name:this.translate.instant("CREATE_PATIENT_SEX_UNKNOWN"),value:"unknown"},{name:this.translate.instant("CREATE_PATIENT_SEX_MALE"),value:"male"},{name:this.translate.instant("CREATE_PATIENT_SEX_FEMALE"),value:"female"}],this.sexModel=[this.sexList[0]],this.numberRegex=new RegExp("(?=.*[0-9])"),this.characterRegex=new RegExp("(?=.*[a-zA-Z])"),this.createPatientForm=this.formBuilder.group({uniqueId:["",r.kI.required],firstName:["",r.kI.required],lastName:["",r.kI.required],sex:[this.sexList[0],r.kI.required],username:["",r.kI.required],temporaryPassword:["",r.kI.compose([r.kI.required,r.kI.minLength(8),r.kI.pattern(new RegExp("(?=.*[0-9])")),r.kI.pattern(new RegExp("(?=.*[a-zA-Z])"))])],patientGroups:["",r.kI.required],address:["",r.kI.required],postalCode:["",r.kI.required],city:["",r.kI.required],phone:[""],email:[""],dateOfBirth:["",r.kI.required]}),this.model={state:"Initial",errors:void 0},this.patientGroupList=[],this.multiselectSettings={singleSelection:!1,idField:"link",textField:"name",searchPlaceholderText:this.translate.instant("SEARCH"),noDataAvailablePlaceholderText:this.translate.instant("NO_DATA_AVAILABLE"),enableCheckAll:!1,allowSearchFilter:!0},this.selectSettings={singleSelection:!0,idField:"value",textField:"name",searchPlaceholderText:this.translate.instant("SEARCH"),noDataAvailablePlaceholderText:this.translate.instant("NO_DATA_AVAILABLE"),enableCheckAll:!1,allowSearchFilter:!1,closeDropDownOnSelection:!0},this.handleError=A=>{this.model.errors=[];const L=A.error.errors;if(this.utils.exists(A.message)&&this.utils.exists(L))for(const U of L){const te=U.code,C=U.field;if("password"!==C&&"invalid"===te){let m="";switch(C){case"cleartextPassword":m=this.translate.instant("CREATE_PATIENT_TEMP_PASSWORD");break;case"uniqueId":m=this.translate.instant("CREATE_PATIENT_UNIQUE_ID");break;case"username":m=this.translate.instant("LOGIN_FORM_USERNAME");break;default:m=this.translate.instant("UNKNOWN")+` (${C})`,console.error(`Unknown field: ${C}`)}const ae=this.translate.instant("CREATE_PATIENT_INVALID_FIELD");this.model.errors.push(`${ae} ${m}`)}}},this.user=this.appContext.currentUser.get(),this.hasPermissions=this.idp2Service.clinicianHasPermissions(),this.user.patientGroups&&this.renderPatientGroups(this.user.patientGroups),this.temporaryPassword.setValue(this.makeTempPassword())}makeTempPassword(){let a="";const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let s=0;s<8;s++)a+=t.charAt(Math.floor(Math.random()*t.length));return this.numberRegex.test(a)&&this.characterRegex.test(a)&&8===a.length?a:this.makeTempPassword()}renderPatientGroups(a){var t;if(this.patientGroupList=[],a)for(const i of a)null===(t=this.patientGroupList)||void 0===t||t.push({name:i.name,link:i.links.patientGroup})}makeRequestBody(a){const t=a;if(t.sex&&(t.sex=t.sex[0].value),t.patientGroups){const i=t.patientGroups;if(delete t.patientGroups,t.links={patientGroups:[]},i)for(const s of i)t.links.patientGroups&&t.links.patientGroups.push(s.link)}return Object.keys(t).forEach(i=>!t[i]&&delete t[i]),t}createPatient(){var a=this;return(0,I.Z)(function*(){a.model.state="Loading",a.model.errors=void 0;const t=a.makeRequestBody(a.createPatientForm.value);try{const i=yield a.patientService.create(a.user,t);let s;yield a.thresholdService.addPatientGroupThresholdsToPatient(i,t.links.patientGroups),a.model.state="Loaded",console.debug(`Patient created with temp password: '${i.temporaryPassword}'`);const p=yield a.idp2Service.getToken(i.links.self);a.authentication.patientAuthHeader(p.type+" "+p.token);const f=yield a.patientService.getSelf(i);s=a.userSession.setPatientUser(f,p),s&&(a.appContext.requestParams.set("selectedPatient",s),a.router.navigate(["/menu"]))}catch(i){a.model.state="Failed",console.error(`Failed to fetch patients due to error: ${i}`),console.error(JSON.stringify(i)),a.handleError(i)}})()}closeMultiselect(){this.elementRef.nativeElement.querySelector("#patient-groups-label").click()}get uniqueId(){return this.createPatientForm.get("uniqueId")}get firstName(){return this.createPatientForm.get("firstName")}get lastName(){return this.createPatientForm.get("firstName")}get sex(){return this.createPatientForm.get("sex")}get dateOfBirth(){return this.createPatientForm.get("dateOfBirth")}get username(){return this.createPatientForm.get("username")}get temporaryPassword(){return this.createPatientForm.get("temporaryPassword")}get patientGroups(){return this.createPatientForm.get("patientGroups")}get address(){return this.createPatientForm.get("address")}get postalCode(){return this.createPatientForm.get("postalCode")}get city(){return this.createPatientForm.get("city")}get phone(){return this.createPatientForm.get("phone")}get email(){return this.createPatientForm.get("email")}}return n.\u0275fac=function(a){return new(a||n)(e.Y36(r.qu),e.Y36(x.P),e.Y36(R.e),e.Y36(E.F0),e.Y36(q.sK),e.Y36(O.c),e.Y36(F.$),e.Y36(w.o),e.Y36(G.W),e.Y36(J),e.Y36(e.SBq))},n.\u0275cmp=e.Xpm({type:n,selectors:[["app-create-patient"]],decls:96,vars:113,consts:[[1,"container"],[3,"title","showChangePasswordBtn","showBackBtn","showLogoutBtn"],["id","notification-permission-warning","class","notification warning",4,"ngIf"],["id","notification-patient-created","class","notification info",4,"ngIf"],["id","notification-patient-error","class","notification error",4,"ngIf"],[1,"content"],[3,"formGroup","ngSubmit"],["id","basic-data",1,"card"],[1,"header"],["aria-hidden","true",1,"icon","fas","fa-user"],[1,"form-group"],["for","unique-id",1,"required"],["id","unique-id","name","unique-id","focusOnLoad","","type","text","autocomplete","off","autocorrect","off","autocapitalize","off","formControlName","uniqueId",3,"ngClass"],["for","first-name",1,"required"],["id","first-name","name","first-name","type","text","autocomplete","off","autocorrect","off","autocapitalize","off","formControlName","firstName",3,"ngClass"],["for","last-name",1,"required"],["id","last-name","name","last-name","type","text","autocomplete","off","autocorrect","off","autocapitalize","off","formControlName","lastName",3,"ngClass"],["for","sex","id","sex-label",1,"required"],["id","sex","formControlName","sex",3,"placeholder","settings","ngModel","data","ngClass","ngModelChange"],["for","data-of-birth",1,"required"],["type","date","id","date-of-birth","formControlName","dateOfBirth",3,"ngClass"],["for","username",1,"required"],["id","username","name","username","type","text","autocomplete","off","autocorrect","off","autocapitalize","off","formControlName","username",3,"ngClass"],["for","temporary-password",1,"required"],["id","temporary-password","name","temporary-password","type","text","autocomplete","off","autocorrect","off","autocapitalize","off","formControlName","temporaryPassword",3,"ngClass"],["for","patient-groups","id","patient-groups-label",1,"required"],["id","patient-groups","formControlName","patientGroups",3,"placeholder","settings","data","ngClass","onSelect","onSelectAll","onDeSelect"],["id","patient-group-threshold-info",1,"notification","info"],[1,"notification_icon","fas","fa-info-circle"],["id","contact-information",1,"card"],["aria-hidden","true",1,"icon","fas","fa-home"],["for","address",1,"required"],["id","address","name","address","type","text","autocomplete","off","autocorrect","off","autocapitalize","off","formControlName","address",3,"ngClass"],["for","postal-code",1,"required"],["id","postal-code","name","postal-code","type","text","autocomplete","off","autocorrect","off","autocapitalize","off","formControlName","postalCode",3,"ngClass"],["for","city",1,"required"],["id","city","name","city","type","text","autocomplete","off","autocorrect","off","autocapitalize","off","formControlName","city",3,"ngClass"],["for","phone"],["id","phone","name","phone","type","text","autocomplete","off","autocorrect","off","autocapitalize","off","formControlName","phone",3,"ngClass"],["for","email"],["id","email","name","email","type","text","autocomplete","off","autocorrect","off","autocapitalize","off","formControlName","email",3,"ngClass"],[1,"button-container"],["id","create","type","submit",1,"contained-create-btn",3,"disabled"],["class","fa fa-user-plus",4,"ngIf"],["class","fa fa-spinner fa-spin",4,"ngIf"],["id","notification-permission-warning",1,"notification","warning"],[1,"notification_icon","fas","fa-exclamation-triangle"],["id","notification-patient-created",1,"notification","info"],["id","notification-patient-error",1,"notification","error"],[1,"notification-list"],["id","notification-error"],[4,"ngFor","ngForOf"],[1,"fa","fa-user-plus"],[1,"fa","fa-spinner","fa-spin"]],template:function(a,t){1&a&&(e.TgZ(0,"div",0),e._UZ(1,"header-menu",1),e.YNc(2,k,4,3,"div",2),e.YNc(3,B,4,3,"div",3),e.YNc(4,D,7,4,"div",4),e.TgZ(5,"nav",5)(6,"form",6),e.NdJ("ngSubmit",function(){return t.createPatient()}),e.TgZ(7,"div",7)(8,"div",8)(9,"h2"),e._UZ(10,"i",9),e._uU(11),e.ALo(12,"translate"),e.qZA()(),e.TgZ(13,"div",10)(14,"label",11),e._uU(15),e.ALo(16,"translate"),e.qZA(),e._UZ(17,"input",12),e.qZA(),e.TgZ(18,"div",10)(19,"label",13),e._uU(20),e.ALo(21,"translate"),e.qZA(),e._UZ(22,"input",14),e.qZA(),e.TgZ(23,"div",10)(24,"label",15),e._uU(25),e.ALo(26,"translate"),e.qZA(),e._UZ(27,"input",16),e.qZA(),e.TgZ(28,"div",10)(29,"label",17),e._uU(30),e.ALo(31,"translate"),e.qZA(),e.TgZ(32,"ng-multiselect-dropdown",18),e.NdJ("ngModelChange",function(s){return t.sexModel=s}),e.ALo(33,"translate"),e.qZA()(),e.TgZ(34,"div",10)(35,"label",19),e._uU(36),e.ALo(37,"translate"),e.qZA(),e._UZ(38,"input",20),e.qZA(),e.TgZ(39,"div",10)(40,"label",21),e._uU(41),e.ALo(42,"translate"),e.qZA(),e._UZ(43,"input",22),e.qZA(),e.TgZ(44,"div",10)(45,"label",23),e._uU(46),e.ALo(47,"translate"),e.qZA(),e._UZ(48,"input",24),e.qZA(),e.TgZ(49,"div",10)(50,"label",25),e._uU(51),e.ALo(52,"translate"),e.qZA(),e.TgZ(53,"ng-multiselect-dropdown",26),e.NdJ("onSelect",function(){return t.closeMultiselect()})("onSelectAll",function(){return t.closeMultiselect()})("onDeSelect",function(){return t.closeMultiselect()}),e.ALo(54,"translate"),e.qZA(),e.TgZ(55,"div",27),e._UZ(56,"i",28),e._uU(57),e.ALo(58,"translate"),e.qZA()()(),e.TgZ(59,"div",29)(60,"div",8)(61,"h2"),e._UZ(62,"i",30),e._uU(63),e.ALo(64,"translate"),e.qZA()(),e.TgZ(65,"div",10)(66,"label",31),e._uU(67),e.ALo(68,"translate"),e.qZA(),e._UZ(69,"input",32),e.qZA(),e.TgZ(70,"div",10)(71,"label",33),e._uU(72),e.ALo(73,"translate"),e.qZA(),e._UZ(74,"input",34),e.qZA(),e.TgZ(75,"div",10)(76,"label",35),e._uU(77),e.ALo(78,"translate"),e.qZA(),e._UZ(79,"input",36),e.qZA(),e.TgZ(80,"div",10)(81,"label",37),e._uU(82),e.ALo(83,"translate"),e.qZA(),e._UZ(84,"input",38),e.qZA(),e.TgZ(85,"div",10)(86,"label",39),e._uU(87),e.ALo(88,"translate"),e.qZA(),e._UZ(89,"input",40),e.qZA()(),e.TgZ(90,"div",41)(91,"button",42),e._uU(92),e.ALo(93,"translate"),e.YNc(94,Y,1,0,"i",43),e.YNc(95,V,1,0,"i",44),e.qZA()()()()()),2&a&&(e.xp6(1),e.Q6J("title","CREATE_PATIENT")("showChangePasswordBtn",!1)("showBackBtn",!0)("showLogoutBtn",!1),e.xp6(1),e.Q6J("ngIf",!t.hasPermissions),e.xp6(1),e.Q6J("ngIf","Loaded"===t.model.state),e.xp6(1),e.Q6J("ngIf","Failed"===t.model.state),e.xp6(2),e.Q6J("formGroup",t.createPatientForm),e.xp6(5),e.hij("",e.lcZ(12,48,"CREATE_PATIENT_BASIC_DATA")," "),e.xp6(4),e.hij("",e.lcZ(16,50,"CREATE_PATIENT_UNIQUE_ID")," "),e.xp6(2),e.Q6J("ngClass",e.VKq(86,d,!t.uniqueId.valid&&!t.uniqueId.pristine)),e.xp6(3),e.Oqu(e.lcZ(21,52,"CREATE_PATIENT_FIRST_NAME")),e.xp6(2),e.Q6J("ngClass",e.VKq(88,d,!t.firstName.valid&&!t.firstName.pristine)),e.xp6(3),e.Oqu(e.lcZ(26,54,"CREATE_PATIENT_LAST_NAME")),e.xp6(2),e.Q6J("ngClass",e.VKq(90,d,!t.lastName.valid&&!t.lastName.pristine)),e.xp6(3),e.Oqu(e.lcZ(31,56,"CREATE_PATIENT_SEX")),e.xp6(2),e.Q6J("placeholder",e.lcZ(33,58,"CREATE_PATIENT_SEX"))("settings",t.selectSettings)("ngModel",t.sexModel)("data",t.sexList)("ngClass",e.VKq(92,d,!t.sex.valid&&!t.sex.pristine)),e.xp6(4),e.Oqu(e.lcZ(37,60,"CREATE_PATIENT_DATE_OF_BIRTH")),e.xp6(2),e.Q6J("ngClass",e.WLB(94,z,!t.dateOfBirth.valid,!t.dateOfBirth.valid&&!t.dateOfBirth.pristine)),e.xp6(3),e.Oqu(e.lcZ(42,62,"LOGIN_FORM_USERNAME")),e.xp6(2),e.Q6J("ngClass",e.VKq(97,d,!t.username.valid&&!t.username.pristine)),e.xp6(3),e.Oqu(e.lcZ(47,64,"CREATE_PATIENT_TEMP_PASSWORD")),e.xp6(2),e.Q6J("ngClass",e.VKq(99,d,!t.temporaryPassword.valid&&!t.temporaryPassword.pristine)),e.xp6(3),e.Oqu(e.lcZ(52,66,"CREATE_PATIENT_PATIENT_GROUPS")),e.xp6(2),e.Q6J("placeholder",e.lcZ(54,68,"CREATE_PATIENT_SELECT_PATIENT_GROUP"))("settings",t.multiselectSettings)("data",t.patientGroupList)("ngClass",e.VKq(101,d,!t.patientGroups.valid&&!t.patientGroups.pristine)),e.xp6(4),e.hij(" ",e.lcZ(58,70,"CREATE_PATIENT_THRESHOLD_INFO")," "),e.xp6(6),e.hij("",e.lcZ(64,72,"CREATE_PATIENT_CONTACT_INFO")," "),e.xp6(4),e.Oqu(e.lcZ(68,74,"CREATE_PATIENT_ADDRESS")),e.xp6(2),e.Q6J("ngClass",e.VKq(103,d,!t.address.valid&&!t.address.pristine)),e.xp6(3),e.Oqu(e.lcZ(73,76,"CREATE_PATIENT_POSTAL_CODE")),e.xp6(2),e.Q6J("ngClass",e.VKq(105,d,!t.postalCode.valid&&!t.postalCode.pristine)),e.xp6(3),e.Oqu(e.lcZ(78,78,"CREATE_PATIENT_CITY")),e.xp6(2),e.Q6J("ngClass",e.VKq(107,d,!t.city.valid&&!t.city.pristine)),e.xp6(3),e.Oqu(e.lcZ(83,80,"CREATE_PATIENT_PHONE")),e.xp6(2),e.Q6J("ngClass",e.VKq(109,d,!t.phone.valid&&!t.phone.pristine)),e.xp6(3),e.Oqu(e.lcZ(88,82,"CREATE_PATIENT_EMAIL")),e.xp6(2),e.Q6J("ngClass",e.VKq(111,d,!t.email.valid&&!t.email.pristine)),e.xp6(2),e.Q6J("disabled",!t.createPatientForm.valid||"Loading"===t.model.state),e.xp6(1),e.hij(" \xa0 ","Loading"!==t.model.state?e.lcZ(93,84,"CREATE_PATIENT"):""," \xa0 "),e.xp6(2),e.Q6J("ngIf","Loading"!==t.model.state),e.xp6(1),e.Q6J("ngIf","Loading"===t.model.state))},dependencies:[h.mk,h.sg,h.O5,b.G,r._Y,r.Fj,r.JJ,r.JL,r.sg,r.u,y.OP,q.X$]}),n})()}];let K=(()=>{class n{}return n.\u0275fac=function(a){return new(a||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[E.Bz.forChild(j),E.Bz]}),n})();var $=o(4546),H=o(4466),X=o(9017);let W=(()=>{class n{}return n.\u0275fac=function(a){return new(a||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[h.ez,K,$.O,H.m,X.I,r.UX,y.ZQ]}),n})()}}]);